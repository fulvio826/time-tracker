<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Time Tracker Clienti</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px auto;
      max-width: 1000px;
      line-height: 1.4;
      font-size: 13px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .top-bar {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    #clientNameInput {
      padding: 6px;
      font-size: 12px;
      flex: 1;
      min-width: 220px;
    }
    button {
      padding: 5px 9px;
      font-size: 11px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background: #f7f7f7;
      white-space: nowrap;
    }
    button:hover {
      background: #eee;
    }
    button.primary {
      background: #000;
      color: #fff;
      border-color: #000;
    }
    button.primary:hover {
      background: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-size: 12px;
      vertical-align: middle;
    }
    th {
      font-weight: 600;
    }
    tr.active-row {
      background: #f7f7f7;
    }
    .time {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 12px;
    }
    .badge-active {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #000;
      color: #fff;
      font-size: 10px;
    }
    .small {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      margin-bottom: 4px;
    }
    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: nowrap;
    }
    .rate-input {
      width: 70px;
      padding: 3px 4px;
      font-size: 11px;
    }
    .cost {
      font-weight: 500;
      font-size: 12px;
    }

    /* Colore compatto all'inizio */
    .color-cell {
      width: 30px;
    }
    .color-wrapper {
      position: relative;
      width: 14px;
      height: 14px;
    }
    .color-swatch {
      position: absolute;
      inset: 0;
      border-radius: 3px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .color-picker {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      border: none;
      padding: 0;
      margin: 0;
    }

    /* LED vicino allo stato */
    .status-content {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .led {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 1px solid #999;
      box-sizing: border-box;
      opacity: 0.25;
      flex-shrink: 0;
    }
    .led-on {
      animation: led-blink 1s infinite;
      opacity: 1;
    }
    @keyframes led-blink {
      0%, 45% {
        opacity: 1;
      }
      50%, 100% {
        opacity: 0.2;
      }
    }

    /* riga sottile colorata a sinistra quando attivo */
    tr[data-id] {
      border-left: 3px solid transparent;
    }
  </style>
</head>
<body>
  <h1>Time Tracker Clienti</h1>
  <div class="top-bar">
    <input type="text" id="clientNameInput" placeholder="Nome cliente o progetto (es. Cliente X - Campagna FW25)" />
    <button class="primary" id="addClientBtn">Aggiungi cliente</button>
    <button id="stopAllBtn">Ferma tutti</button>
    <button id="backupBtn">Esporta backup</button>
    <button id="importBtn">Importa backup</button>
  </div>
  <div class="small">
    ✔ I dati vengono salvati su Supabase (tabella <b>projects</b>) e sono visibili da Mac e telefono.<br />
    ✔ Puoi avere anche più clienti attivi contemporaneamente.<br />
    ✔ Puoi aggiungere minuti extra, impostare la tariffa €/h e scegliere un colore per cliente.<br />
    ✔ Il backup esportato/importato è un file .json (puoi tenerlo su iCloud, Supabase storage, ecc).
  </div>

  <table id="clientsTable">
    <thead>
      <tr>
        <th style="width:30px;">Colore</th>
        <th>Cliente / Progetto</th>
        <th>Tempo totale</th>
        <th>Tariffa oraria (€)</th>
        <th>Importo stimato (€)</th>
        <th>Stato</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody id="clientsTbody">
      <!-- Righe generate via JavaScript -->
    </tbody>
  </table>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // CONFIGURAZIONE SUPABASE
    const SUPABASE_URL = "https://chyesztwritnxwpdogor.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_FuO7GE4E0BFz42W9OsHTUw_TfPZwg_p";
    const WORKSPACE_ID = "FULVIO";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // client: { id, name, totalMs, hourlyRate, color, isActive, lastStart }
    let clients = [];

    const COLOR_PALETTE = [
      "#FF6B6B",
      "#4ECDC4",
      "#FFD93D",
      "#1A535C",
      "#FF9F1C",
      "#9B5DE5",
      "#00BBF9",
      "#38B000"
    ];

    function getDefaultColor(index) {
      return COLOR_PALETTE[index % COLOR_PALETTE.length];
    }

    function formatMs(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const seconds = totalSeconds % 60;
      const totalMinutes = Math.floor(totalSeconds / 60);
      const minutes = totalMinutes % 60;
      const hours = Math.floor(totalMinutes / 60);
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    function formatCurrency(num) {
      if (!isFinite(num)) return "-";
      return num.toFixed(2);
    }

    function getClientById(id) {
      return clients.find(c => c.id === id);
    }

    // ----- CARICAMENTO DA SUPABASE -----
    async function loadFromSupabase() {
      const { data, error } = await supabaseClient
        .from("projects")
        .select("id, name, total_ms, hourly_rate, color, is_active, last_start, workspace_id")
        .eq("workspace_id", WORKSPACE_ID)
        .order("name", { ascending: true });

      if (error) {
        console.error("Errore caricando da Supabase:", error);
        alert("Errore nel caricare i dati da Supabase. Controlla la console.");
        return;
      }

      clients = (data || []).map((c, index) => ({
        id: c.id,
        name: c.name || "Senza nome",
        totalMs: c.total_ms || 0,
        hourlyRate: c.hourly_rate ? Number(c.hourly_rate) : 0,
        color: c.color || getDefaultColor(index),
        isActive: c.is_active || false,
        lastStart: c.last_start ? Number(c.last_start) : null
      }));

      renderTable();
    }

    async function saveClientState(client) {
      if (!client.id) return;
      const { error } = await supabaseClient
        .from("projects")
        .update({
          name: client.name,
          total_ms: client.totalMs,
          hourly_rate: client.hourlyRate,
          color: client.color,
          is_active: client.isActive,
          last_start: client.lastStart,
          workspace_id: WORKSPACE_ID
        })
        .eq("id", client.id)
        .eq("workspace_id", WORKSPACE_ID);

      if (error) {
        console.error("Errore aggiornando Supabase:", error);
      }
    }

    async function stopAllClients() {
      const now = Date.now();
      const toUpdate = [];

      clients.forEach(c => {
        if (c.isActive && c.lastStart != null) {
          c.totalMs += now - c.lastStart;
          c.isActive = false;
          c.lastStart = null;
          toUpdate.push(saveClientState(c));
        }
      });

      if (toUpdate.length > 0) {
        await Promise.all(toUpdate);
      }
      renderTable();
    }

    // multi-timer: ogni cliente è indipendente
    async function activateClient(id) {
      const client = getClientById(id);
      if (!client) return;
      const now = Date.now();

      if (client.isActive) {
        // metti in pausa
        client.totalMs += now - client.lastStart;
        client.isActive = false;
        client.lastStart = null;
      } else {
        // attiva
        client.isActive = true;
        client.lastStart = now;
      }

      await saveClientState(client);
      renderTable();
    }

    async function resetClient(id) {
      const client = getClientById(id);
      if (!client) return;
      const conferma = confirm(`Azzerare il tempo per "${client.name}"?`);
      if (!conferma) return;

      client.totalMs = 0;
      client.isActive = false;
      client.lastStart = null;
      await saveClientState(client);
      renderTable();
    }

    async function deleteClient(id) {
      const client = getClientById(id);
      if (!client) return;
      const conferma = confirm(`Eliminare il cliente "${client.name}"? Il tempo conteggiato andrà perso.`);
      if (!conferma) return;

      clients = clients.filter(c => c.id !== id);
      renderTable();

      const { error } = await supabaseClient
        .from("projects")
        .delete()
        .eq("id", id)
        .eq("workspace_id", WORKSPACE_ID);

      if (error) {
        console.error("Errore eliminando su Supabase:", error);
        alert("Errore nell'eliminazione su Supabase (vedi console).");
      }
    }

    async function addClient(name) {
      const trimmed = name.trim();
      if (!trimmed) return;
      const index = clients.length;
      const color = getDefaultColor(index);

      const { data, error } = await supabaseClient
        .from("projects")
        .insert({
          name: trimmed,
          total_ms: 0,
          hourly_rate: 0,
          color: color,
          is_active: false,
          last_start: null,
          workspace_id: WORKSPACE_ID
        })
        .select()
        .single();

      if (error) {
        console.error("Errore aggiungendo cliente su Supabase:", error);
        alert("Errore nell'aggiunta del cliente (vedi console).");
        return;
      }

      const newClient = {
        id: data.id,
        name: data.name || trimmed,
        totalMs: data.total_ms || 0,
        hourlyRate: data.hourly_rate ? Number(data.hourly_rate) : 0,
        color: data.color || color,
        isActive: data.is_active || false,
        lastStart: data.last_start ? Number(data.last_start) : null
      };

      clients.push(newClient);
      renderTable();
    }

    async function addExtraMinutes(id) {
      const client = getClientById(id);
      if (!client) return;

      const value = prompt(`Quanti minuti extra vuoi aggiungere a "${client.name}"?`, "15");
      if (value === null) return;

      const minutes = parseFloat(String(value).replace(",", "."));
      if (isNaN(minutes) || minutes <= 0) {
        alert("Inserisci un numero di minuti valido (maggiore di 0).");
        return;
      }

      client.totalMs += minutes * 60 * 1000;
      await saveClientState(client);
      renderTable();
    }

    async function updateHourlyRate(id, newRateStr) {
      const client = getClientById(id);
      if (!client) return;
      const clean = String(newRateStr).replace(",", ".");
      const rate = parseFloat(clean);
      client.hourlyRate = isNaN(rate) || rate < 0 ? 0 : rate;
      // non faccio render per non perdere il focus
      saveClientState(client);
    }

    async function updateClientColor(id, newColor) {
      const client = getClientById(id);
      if (!client) return;
      client.color = newColor || "#CCCCCC";
      saveClientState(client);
      updateLiveValues();
    }

    // ----- EXPORT BACKUP -----
    function exportBackup() {
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        clients: clients.map(c => ({
          id: c.id,
          name: c.name,
          totalMs: c.totalMs,
          hourlyRate: c.hourlyRate,
          color: c.color,
          isActive: c.isActive,
          lastStart: c.lastStart
        }))
      };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const now = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const fileName = `time-tracker-backup-${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}.json`;

      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert("Backup esportato.");
    }

    // ----- IMPORT BACKUP (sovrascrive tutto il workspace su Supabase) -----
    async function importBackup() {
      const conferma = confirm(
        "Importando un backup sovrascriverai tutti i dati attuali del workspace 'FULVIO' su Supabase.\n\nVuoi continuare?"
      );
      if (!conferma) return;

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "application/json,.json";

      fileInput.onchange = async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const text = e.target.result;
            const data = JSON.parse(text);

            if (!data || !Array.isArray(data.clients)) {
              alert("Backup non valido: formato inatteso.");
              return;
            }

            // 1) cancello tutti i progetti del workspace
            const { error: delError } = await supabaseClient
              .from("projects")
              .delete()
              .eq("workspace_id", WORKSPACE_ID);

            if (delError) {
              console.error("Errore cancellando i project su Supabase:", delError);
              alert("Errore nella pulizia su Supabase (vedi console).");
              return;
            }

            // 2) inserisco i nuovi dal backup
            if (data.clients.length > 0) {
              const rows = data.clients.map((c, index) => ({
                name: c.name || "Senza nome",
                total_ms: c.totalMs || 0,
                hourly_rate: c.hourlyRate || 0,
                color: c.color || getDefaultColor(index),
                is_active: false,
                last_start: null,
                workspace_id: WORKSPACE_ID
              }));

              const { error: insError } = await supabaseClient
                .from("projects")
                .insert(rows);

              if (insError) {
                console.error("Errore inserendo da backup su Supabase:", insError);
                alert("Errore durante l'import su Supabase (vedi console).");
                return;
              }
            }

            // 3) ricarico tutto
            await loadFromSupabase();
            alert("Backup importato e sincronizzato su Supabase.");
          } catch (err) {
            console.error("Errore durante l'import del backup:", err);
            alert("Errore durante la lettura del backup. Verifica il file selezionato.");
          }
        };

        reader.readAsText(file);
      };

      fileInput.click();
    }

    // ----- RENDER TABELLA -----
    function renderTable() {
      const tbody = document.getElementById("clientsTbody");
      tbody.innerHTML = "";

      if (clients.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "Nessun cliente ancora aggiunto.";
        td.style.color = "#666";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      clients.forEach(client => {
        const tr = document.createElement("tr");
        tr.dataset.id = client.id;

        // Colore
        const colorTd = document.createElement("td");
        colorTd.className = "color-cell";
        const wrapper = document.createElement("div");
        wrapper.className = "color-wrapper";

        const swatch = document.createElement("div");
        swatch.className = "color-swatch";
        swatch.style.backgroundColor = client.color || "#CCCCCC";

        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.className = "color-picker";
        colorInput.value = client.color || "#CCCCCC";
        colorInput.oninput = (e) => {
          updateClientColor(client.id, e.target.value);
        };

        wrapper.appendChild(swatch);
        wrapper.appendChild(colorInput);
        colorTd.appendChild(wrapper);

        // Nome
        const nameTd = document.createElement("td");
        nameTd.textContent = client.name;

        // Tempo totale
        const timeTd = document.createElement("td");
        timeTd.className = "time";

        // Tariffa oraria
        const rateTd = document.createElement("td");
        const rateInput = document.createElement("input");
        rateInput.type = "text";
        rateInput.className = "rate-input";
        rateInput.placeholder = "0.00";
        rateInput.value = client.hourlyRate ? client.hourlyRate : "";
        rateInput.oninput = (e) => {
          updateHourlyRate(client.id, e.target.value);
        };
        rateTd.appendChild(rateInput);

        // Importo stimato
        const costTd = document.createElement("td");
        costTd.className = "cost";

        // Stato
        const statusTd = document.createElement("td");
        statusTd.className = "status";

        // Azioni
        const actionsTd = document.createElement("td");
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "actions";

        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = client.isActive ? "Metti in pausa" : "Attiva";
        toggleBtn.onclick = () => activateClient(client.id);

        const extraBtn = document.createElement("button");
        extraBtn.textContent = "+ Minuti extra";
        extraBtn.onclick = () => addExtraMinutes(client.id);

        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Azzera";
        resetBtn.onclick = () => resetClient(client.id);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Elimina";
        deleteBtn.onclick = () => deleteClient(client.id);

        actionsDiv.appendChild(toggleBtn);
        actionsDiv.appendChild(extraBtn);
        actionsDiv.appendChild(resetBtn);
        actionsDiv.appendChild(deleteBtn);
        actionsTd.appendChild(actionsDiv);

        tr.appendChild(colorTd);
        tr.appendChild(nameTd);
        tr.appendChild(timeTd);
        tr.appendChild(rateTd);
        tr.appendChild(costTd);
        tr.appendChild(statusTd);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
      });

      updateLiveValues();
    }

    function updateLiveValues() {
      const now = Date.now();

      clients.forEach(client => {
        const tr = document.querySelector(`tr[data-id="${client.id}"]`);
        if (!tr) return;

        const timeTd = tr.querySelector(".time");
        const costTd = tr.querySelector(".cost");
        const statusTd = tr.querySelector(".status");
        const toggleBtn = tr.querySelector("button");
        const swatch = tr.querySelector(".color-swatch");

        let displayedMs = client.totalMs;
        if (client.isActive && client.lastStart != null) {
          displayedMs += now - client.lastStart;
        }

        if (timeTd) {
          timeTd.textContent = formatMs(displayedMs);
        }

        if (costTd) {
          if (client.hourlyRate && client.hourlyRate > 0) {
            const hours = displayedMs / (1000 * 60 * 60);
            const cost = hours * client.hourlyRate;
            costTd.textContent = formatCurrency(cost);
          } else {
            costTd.textContent = "-";
          }
        }

        // Stato + LED
        if (statusTd) {
          statusTd.innerHTML = "";
          const wrapper = document.createElement("div");
          wrapper.className = "status-content";

          const led = document.createElement("div");
          led.className = "led";
          led.style.backgroundColor = client.color || "#CCCCCC";

          if (client.isActive) {
            led.classList.add("led-on");
            const badge = document.createElement("span");
            badge.className = "badge-active";
            badge.textContent = "IN CORSO";
            wrapper.appendChild(led);
            wrapper.appendChild(badge);
          } else {
            const label = document.createElement("span");
            label.textContent = "In pausa";
            wrapper.appendChild(led);
            wrapper.appendChild(label);
          }

          statusTd.appendChild(wrapper);
        }

        if (toggleBtn) {
          toggleBtn.textContent = client.isActive ? "Metti in pausa" : "Attiva";
        }

        if (swatch) {
          swatch.style.backgroundColor = client.color || "#CCCCCC";
        }

        if (client.isActive) {
          tr.classList.add("active-row");
          tr.style.borderLeft = `3px solid ${client.color || "#000000"}`;
        } else {
          tr.classList.remove("active-row");
          tr.style.borderLeft = "3px solid transparent";
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("clientNameInput");
      const addBtn = document.getElementById("addClientBtn");
      const stopAllBtn = document.getElementById("stopAllBtn");
      const backupBtn = document.getElementById("backupBtn");
      const importBtn = document.getElementById("importBtn");

      addBtn.addEventListener("click", () => {
        addClient(input.value);
        input.value = "";
        input.focus();
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          addClient(input.value);
          input.value = "";
        }
      });

      stopAllBtn.addEventListener("click", () => {
        stopAllClients();
      });

      backupBtn.addEventListener("click", () => {
        exportBackup();
      });

      importBtn.addEventListener("click", () => {
        importBackup();
      });

      loadFromSupabase();

      // aggiorno solo la parte visuale (tempo/importi/LED)
      setInterval(() => {
        updateLiveValues();
      }, 1000);
    });
  </script>
</body>
</html>